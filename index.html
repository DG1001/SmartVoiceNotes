<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#3b82f6">
    <title>SmartVoice Notes - KI-gestützte Sprachnotizen</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" href="./logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .note-card {
            transition: all 0.3s ease;
        }
        .note-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .pulse-recording {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-microphone-alt text-blue-500 text-2xl"></i>
                    <h1 class="text-2xl font-bold text-gray-800">Smart<span class="text-blue-500">Voice</span> Notes</h1>
                </div>
                <button id="exportBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md flex items-center">
                    <i class="fas fa-file-export mr-2"></i> Exportieren
                </button>
            </div>
        </header>

        <!-- API Key Input -->
        <div class="bg-white p-4 rounded-lg shadow-md mb-6" id="apiKeySection">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-lg font-semibold">OpenAI API Konfiguration</h2>
                <button id="toggleApiKeyBtn" class="text-blue-500 hover:text-blue-700">
                    <i class="fas fa-chevron-down" id="toggleApiKeyIcon"></i>
                </button>
            </div>
            <div id="apiKeyContent" class="hidden">
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="password" id="apiKeyInput" placeholder="Ihren OpenAI API-Key eingeben" 
                           class="flex-grow px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="saveApiKeyBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md">
                        <i class="fas fa-save mr-2"></i> Speichern
                    </button>
                </div>
                <p class="text-sm text-gray-500 mt-2">Ihr API-Key wird nur lokal im Browser gespeichert und nicht an uns übertragen.</p>
            </div>
            <div id="apiKeyStatus" class="text-sm text-green-600 flex items-center">
                <i class="fas fa-check-circle mr-2"></i>
                <span>API-Key ist gesetzt</span>
                <button id="changeApiKeyBtn" class="text-blue-500 hover:text-blue-700 ml-2 text-xs">
                    Ändern
                </button>
            </div>
        </div>

        <!-- Recording Section -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-lg font-semibold mb-4">Neue Sprachnotiz erstellen</h2>
            <div class="flex flex-col items-center">
                <button id="recordBtn" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-full mb-4 flex items-center">
                    <i class="fas fa-microphone mr-2"></i>
                    <span id="recordText">Aufnahme starten</span>
                </button>
                <div id="recordingStatus" class="text-gray-500 mb-4 hidden">
                    <i class="fas fa-circle text-red-500 mr-2 pulse-recording"></i>
                    <span>Aufnahme läuft...</span>
                </div>
                <div id="transcriptContainer" class="w-full mb-4 hidden">
                    <h3 class="font-medium mb-2">Transkript:</h3>
                    <div id="transcript" class="bg-gray-100 p-3 rounded-md min-h-20"></div>
                </div>
                <div class="flex space-x-3 w-full">
                    <button id="saveBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md flex-1 hidden">
                        <i class="fas fa-save mr-2"></i> Speichern
                    </button>
                    <button id="analyzeBtn" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-md flex-1 hidden">
                        <i class="fas fa-robot mr-2"></i> Mit KI analysieren
                    </button>
                </div>
            </div>
        </div>

        <!-- Notes List -->
        <div>
            <h2 class="text-lg font-semibold mb-4">Ihre Notizen</h2>
            <div id="notesList" class="space-y-4">
                <!-- Notes will be added here dynamically -->
                <div class="text-center py-10 text-gray-500" id="emptyState">
                    <i class="fas fa-notes-medical text-4xl mb-3"></i>
                    <p>Noch keine Notizen vorhanden. Starten Sie eine Aufnahme!</p>
                </div>
            </div>
        </div>

        <!-- Offline Alert -->
        <div id="offlineAlert" class="fixed bottom-4 right-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded shadow-md hidden">
            <div class="flex">
                <div class="py-1"><i class="fas fa-wifi text-yellow-500 mr-3"></i></div>
                <div>
                    <p class="font-bold">Offline-Modus</p>
                    <p class="text-sm">Sie sind offline. Einige Funktionen sind möglicherweise eingeschränkt.</p>
                </div>
            </div>
        </div>

        <!-- Note Detail Modal -->
        <div id="noteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-auto">
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-bold" id="modalTitle">Notiz Details</h3>
                        <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-medium text-gray-700 mb-1">Originaltext:</h4>
                            <p id="modalOriginalText" class="bg-gray-100 p-3 rounded-md"></p>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-700 mb-1">KI-Analyse:</h4>
                            <div id="modalAnalysis" class="bg-blue-50 p-3 rounded-md">
                                <div class="grid grid-cols-2 gap-4 mb-3">
                                    <div>
                                        <p class="text-sm text-gray-500">Kategorie:</p>
                                        <p id="modalCategory" class="font-medium"></p>
                                    </div>
                                    <div>
                                        <p class="text-sm text-gray-500">Schlüsselwörter:</p>
                                        <p id="modalKeywords" class="font-medium"></p>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-sm text-gray-500">Zusammenfassung:</p>
                                    <p id="modalSummary" class="mt-1"></p>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-between space-x-2 pt-4">
                            <button id="modalAnalyzeBtn" class="text-purple-500 hover:text-purple-700 flex items-center" style="display: none;">
                                <i class="fas fa-robot mr-2"></i> Mit KI analysieren
                            </button>
                            <button id="deleteNoteBtn" class="text-red-500 hover:text-red-700 flex items-center">
                                <i class="fas fa-trash mr-2"></i> Löschen
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const recordBtn = document.getElementById('recordBtn');
        const recordText = document.getElementById('recordText');
        const recordingStatus = document.getElementById('recordingStatus');
        const transcriptContainer = document.getElementById('transcriptContainer');
        const transcript = document.getElementById('transcript');
        const saveBtn = document.getElementById('saveBtn');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const notesList = document.getElementById('notesList');
        const emptyState = document.getElementById('emptyState');
        const noteModal = document.getElementById('noteModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const modalOriginalText = document.getElementById('modalOriginalText');
        const modalCategory = document.getElementById('modalCategory');
        const modalKeywords = document.getElementById('modalKeywords');
        const modalSummary = document.getElementById('modalSummary');
        const modalAnalyzeBtn = document.getElementById('modalAnalyzeBtn');
        const deleteNoteBtn = document.getElementById('deleteNoteBtn');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');
        const exportBtn = document.getElementById('exportBtn');

        // App State
        let notes = JSON.parse(localStorage.getItem('smartVoiceNotes')) || [];
        let currentTranscript = '';
        let isRecording = false;
        let recognition;
        let selectedNoteId = null;
        let apiKey = localStorage.getItem('openaiApiKey') || '';

        // Initialize
        apiKeyInput.value = apiKey;
        updateApiKeyUI();
        renderNotes();

        // Web Speech API Setup
        function setupSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                alert("Ihr Browser unterstützt die Web Speech API nicht. Bitte verwenden Sie Chrome oder Edge.");
                return;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'de-DE';

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }

                currentTranscript = finalTranscript || interimTranscript;
                transcript.textContent = currentTranscript;
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error', event.error);
                stopRecording();
                alert(`Fehler bei der Spracherkennung: ${event.error}`);
            };
        }

        // Recording Control
        function startRecording() {
            if (!recognition) setupSpeechRecognition();
            
            try {
                recognition.start();
                isRecording = true;
                recordBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                recordBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                recordText.textContent = 'Aufnahme stoppen';
                recordingStatus.classList.remove('hidden');
                transcriptContainer.classList.remove('hidden');
                saveBtn.classList.add('hidden');
                analyzeBtn.classList.add('hidden');
                transcript.textContent = '';
                currentTranscript = '';
            } catch (e) {
                console.error('Recording start failed:', e);
                alert('Aufnahme konnte nicht gestartet werden. Bitte Mikrofon freigeben.');
            }
        }

        function stopRecording() {
            if (recognition) {
                recognition.stop();
            }
            isRecording = false;
            recordBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
            recordBtn.classList.add('bg-red-500', 'hover:bg-red-600');
            recordText.textContent = 'Aufnahme starten';
            recordingStatus.classList.add('hidden');
            
            if (currentTranscript.trim()) {
                saveBtn.classList.remove('hidden');
                analyzeBtn.classList.remove('hidden');
            }
        }

        // Note Management
        function saveNote() {
            if (!currentTranscript.trim()) return;

            const newNote = {
                id: Date.now().toString(),
                text: currentTranscript.trim(),
                createdAt: new Date().toISOString(),
                analyzed: false
            };

            notes.unshift(newNote);
            saveNotes();
            renderNotes();
            resetRecordingUI();
        }

        async function analyzeWithAI(text = null) {
            const textToAnalyze = text || currentTranscript.trim();
            if (!textToAnalyze) return;
            if (!apiKey) {
                alert('Bitte geben Sie zuerst einen OpenAI API-Key ein.');
                apiKeyInput.focus();
                return;
            }

            // Bestimme, welcher Button aktualisiert werden soll
            const buttonToUpdate = text && selectedNoteId ? modalAnalyzeBtn : analyzeBtn;
            const originalButtonHTML = buttonToUpdate.innerHTML;
            
            buttonToUpdate.disabled = true;
            buttonToUpdate.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Analysiere...';

            try {
                const prompt = `Analysiere die folgende Notiz in deutscher Sprache und gib eine JSON-Antwort zurück mit:
- "category": Die passendste Kategorie (z.B. "Einkaufsliste", "Termin", "Idee", "Aufgabe", "Erinnerung")
- "keywords": 3-5 relevante Schlüsselwörter, kommagetrennt
- "summary": Eine kurze, prägnante Zusammenfassung des Inhalts

Notiz: ${textToAnalyze}`;

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: [{ role: "user", content: prompt }],
                        temperature: 0.7,
                        response_format: { type: "json_object" }
                    })
                });

                if (!response.ok) {
                    throw new Error(`API-Fehler: ${response.status} - ${await response.text()}`);
                }

                const data = await response.json();
                console.log('API response:', data);
                
                let analysis;
                try {
                    // Versuche direkt das JSON zu verwenden
                    analysis = JSON.parse(data.choices[0].message.content);
                } catch (e) {
                    console.error('JSON parsing error:', e);
                    // Fallback: Verwende ein einfaches Objekt mit Standardwerten
                    analysis = {
                        category: 'Allgemein',
                        keywords: 'nicht verfügbar',
                        summary: data.choices[0].message.content || 'Zusammenfassung nicht verfügbar'
                    };
                }

                // Wenn wir eine bestehende Notiz analysieren
                if (text && selectedNoteId) {
                    const noteIndex = notes.findIndex(n => n.id === selectedNoteId);
                    if (noteIndex !== -1) {
                        notes[noteIndex].analyzed = true;
                        notes[noteIndex].analysis = {
                            category: analysis.category,
                            keywords: analysis.keywords,
                            summary: analysis.summary
                        };
                        
                        // Aktualisiere die Modalansicht
                        modalCategory.textContent = analysis.category;
                        modalKeywords.textContent = analysis.keywords;
                        modalSummary.textContent = analysis.summary;
                        modalAnalyzeBtn.style.display = 'none';
                    }
                } else {
                    // Erstelle eine neue Notiz
                    const newNote = {
                        id: Date.now().toString(),
                        text: textToAnalyze,
                        createdAt: new Date().toISOString(),
                        analyzed: true,
                        analysis: {
                            category: analysis.category,
                            keywords: analysis.keywords,
                            summary: analysis.summary
                        }
                    };
                    notes.unshift(newNote);
                    resetRecordingUI();
                }
                saveNotes();
                renderNotes();
            } catch (error) {
                console.error('AI Analysis error:', error);
                alert('Fehler bei der KI-Analyse: ' + error.message);
            } finally {
                buttonToUpdate.disabled = false;
                buttonToUpdate.innerHTML = originalButtonHTML;
            }
        }

        function deleteNote(id) {
            notes = notes.filter(note => note.id !== id);
            saveNotes();
            renderNotes();
            noteModal.classList.add('hidden');
        }

        function saveNotes() {
            localStorage.setItem('smartVoiceNotes', JSON.stringify(notes));
        }

        function saveApiKey() {
            apiKey = apiKeyInput.value.trim();
            localStorage.setItem('openaiApiKey', apiKey);
            updateApiKeyUI();
            alert('API-Key wurde gespeichert!');
        }

        function updateApiKeyUI() {
            const apiKeyContent = document.getElementById('apiKeyContent');
            const apiKeyStatus = document.getElementById('apiKeyStatus');
            const toggleApiKeyIcon = document.getElementById('toggleApiKeyIcon');
            
            if (apiKey) {
                apiKeyContent.classList.add('hidden');
                apiKeyStatus.classList.remove('hidden');
                toggleApiKeyIcon.classList.remove('fa-chevron-up');
                toggleApiKeyIcon.classList.add('fa-chevron-down');
            } else {
                apiKeyContent.classList.remove('hidden');
                apiKeyStatus.classList.add('hidden');
            }
        }

        function exportNotes() {
            if (notes.length === 0) {
                alert('Keine Notizen zum Exportieren vorhanden.');
                return;
            }

            const dataStr = JSON.stringify(notes, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `smartvoice-notes-${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // UI Rendering
        function renderNotes() {
            if (notes.length === 0) {
                emptyState.classList.remove('hidden');
                notesList.innerHTML = '';
                return;
            }

            emptyState.classList.add('hidden');
            notesList.innerHTML = '';

            notes.forEach(note => {
                const noteElement = document.createElement('div');
                noteElement.className = 'note-card bg-white p-4 rounded-lg shadow-sm cursor-pointer hover:shadow-md';
                noteElement.dataset.id = note.id;

                let keywordsHtml = '';
                if (note.analyzed && note.analysis.keywords) {
                    const keywords = note.analysis.keywords.split(',').map(k => k.trim());
                    keywordsHtml = keywords.map(k => 
                        `<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded mr-1">${k}</span>`
                    ).join('');
                }

                noteElement.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-medium truncate">${note.analyzed ? note.analysis.category : 'Neue Notiz'}</h3>
                        <span class="text-xs text-gray-500">${new Date(note.createdAt).toLocaleString()}</span>
                    </div>
                    <p class="text-gray-600 text-sm mb-2 line-clamp-2">${note.analyzed ? note.analysis.summary : note.text}</p>
                    <div class="flex justify-between items-center">
                        <div>${keywordsHtml}</div>
                        ${note.analyzed ? 
                          '<span class="bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded"><i class="fas fa-robot mr-1"></i> KI-analyzed</span>' : 
                          '<span class="bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded">Unbearbeitet</span>'}
                    </div>
                `;

                noteElement.addEventListener('click', () => openNoteModal(note.id));
                notesList.appendChild(noteElement);
            });
        }

        function openNoteModal(id) {
            const note = notes.find(n => n.id === id);
            if (!note) return;

            selectedNoteId = id;
            modalOriginalText.textContent = note.text;
            
            if (note.analyzed) {
                modalCategory.textContent = note.analysis.category;
                modalKeywords.textContent = note.analysis.keywords;
                modalSummary.textContent = note.analysis.summary;
                modalAnalyzeBtn.style.display = 'none';
            } else {
                modalCategory.textContent = 'Nicht analysiert';
                modalKeywords.textContent = 'Nicht analysiert';
                modalSummary.textContent = 'Diese Notiz wurde noch nicht mit der KI analysiert.';
                modalAnalyzeBtn.style.display = 'flex';
            }

            noteModal.classList.remove('hidden');
        }

        function resetRecordingUI() {
            currentTranscript = '';
            transcript.textContent = '';
            transcriptContainer.classList.add('hidden');
            saveBtn.classList.add('hidden');
            analyzeBtn.classList.add('hidden');
        }

        // Offline detection
        const offlineAlert = document.getElementById('offlineAlert');
        
        function updateOnlineStatus() {
            if (navigator.onLine) {
                offlineAlert.classList.add('hidden');
            } else {
                offlineAlert.classList.remove('hidden');
            }
        }
        
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus(); // Initial check
        
        // Event Listeners
        recordBtn.addEventListener('click', () => {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        });

        saveBtn.addEventListener('click', saveNote);
        analyzeBtn.addEventListener('click', analyzeWithAI);
        closeModalBtn.addEventListener('click', () => noteModal.classList.add('hidden'));
        modalAnalyzeBtn.addEventListener('click', async () => {
            if (selectedNoteId) {
                const note = notes.find(n => n.id === selectedNoteId);
                if (note && !note.analyzed) {
                    await analyzeWithAI(note.text);
                }
            }
        });

        deleteNoteBtn.addEventListener('click', () => {
            if (selectedNoteId) {
                deleteNote(selectedNoteId);
            }
        });
        saveApiKeyBtn.addEventListener('click', saveApiKey);
        exportBtn.addEventListener('click', exportNotes);
        
        // API Key UI controls
        document.getElementById('toggleApiKeyBtn').addEventListener('click', () => {
            const apiKeyContent = document.getElementById('apiKeyContent');
            const toggleApiKeyIcon = document.getElementById('toggleApiKeyIcon');
            
            apiKeyContent.classList.toggle('hidden');
            toggleApiKeyIcon.classList.toggle('fa-chevron-down');
            toggleApiKeyIcon.classList.toggle('fa-chevron-up');
        });
        
        document.getElementById('changeApiKeyBtn').addEventListener('click', () => {
            const apiKeyContent = document.getElementById('apiKeyContent');
            const toggleApiKeyIcon = document.getElementById('toggleApiKeyIcon');
            
            apiKeyContent.classList.remove('hidden');
            toggleApiKeyIcon.classList.remove('fa-chevron-down');
            toggleApiKeyIcon.classList.add('fa-chevron-up');
        });

        // Close modal when clicking outside
        noteModal.addEventListener('click', (e) => {
            if (e.target === noteModal) {
                noteModal.classList.add('hidden');
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !noteModal.classList.contains('hidden')) {
                noteModal.classList.add('hidden');
            }
        });
    </script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
    </script>
</body>
</html>
